<!DOCTYPE html>
<html>
	<head>
		<title>KoLMobile</title>
		<meta name="viewport" id="viewport" content="width=device-width, target-densitydpi=device-dpi, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script type="text/javascript">
			var droid = new Android();
			droid.objectPost = function(name, obj) {
				droid.eventPost(name, JSON.stringify(obj));
			};
			
			
			/*
			* All layouts have 3 required attributes:
			*  - layout: This is the HTML code for the layout
			*  - setup: This is the function that is called after the layout is changed, so the layout may add event handlers and the like. Should never be called directly.
			*  - cleanup: This is the function called when the layout is destroyed. It is here for cleanup work, such as removing event handlers and ending timers. Should never be called directly.
			* Layouts can be extended with functions or variables by calling extend. Example:
			* var example = new Layout();
			* example.extend("functionName", function(arg1, arg2) {
			* 	//code here
			* });
			* //call the function here
			* example.functionName("foo", "bar");
			*
			* Arguments:
			*  - layout: HTML code for the view
			*  - setup: Function to call when layout is rendered
			*  - cleanup: Function to call when layout is destroyed
			*  - actionBar: action bar to use for this layout, if null, default will be used
			*/
			function Layout(layout, setup, cleanup, actionBar) {
				this.layout = layout;
				(setup == null) ? (this.setup = function() {}) : (this.setup = setup);
				(cleanup == null) ? (this.cleanup = function() {}) : (this.cleanup = cleanup);
				(actionBar == null) ? (this.actionBar = util.defaultActionBar) : (this.actionBar = actionBar);
				this.extend = function(func, code) {
					this[func] = code;
				};
				this.render = function() {
					document.getElementById("container").innerHTML = this.layout;
					(this.actionbar != null) ? (this.actionBar.render()) : (util.defaultActionBar.render());
				}
			}
			
			/*
			* Arguments:
			*  - left: Array of HTMLLiElements for left part of action bar
			*  - right: Array of HTMLLiElements for right part of action bar
			*  - options: Array of HTMLLiElement for the menu actions
			*  - setup: Function to call when layout is rendered
			*  - cleanup: Function to call when layout is destroyed
			*/
			function ActionBar(left, right, options, setup, cleanup) {
				var defaults = {
					left: [],
					right: [],
					options: []
				};
				(left == null) ? (this.left = defaults.left) : (this.left = left);
				(right == null) ? (this.right = defaults.right) : (this.right = right);
				(options == null) ? (this.options = defaults.options) : (this.options = options);
				(setup == null) ? (this.setup = function() {}) : (this.setup = setup);
				(cleanup == null) ? (this.cleanup = function() {}) : (this.cleanup = cleanup);
				this.extend = function(func, code) {
					this[func] = code;
				};
				this.render = function() {
					document.getElementById("left").innerHTML = "";
					this.left.forEach(function(item) {
						document.getElementById("left").appendChild(item);
					});
					document.getElementById("right").innerHTML = "";
					this.right.forEach(function(item) {
						document.getElementById("right").appendChild(item);
					});
					document.getElementById("options").innerHTML = "";
					this.options.forEach(function(item) {
						document.getElementById("options").appendChild(item);
					});
				}
			}
			
			/*
			* Arguments:
			*  - options: Array of HTMLLiElements for when the drawer is opened
			*  - setup: Function to call when drawer is rendered
			*  - cleanup: Function to call when drawer is destroyed
			*/
			function Drawer(options, setup, cleanup) {
				(options == null) ? (this.options = []) : (this.options = options);
				(setup == null) ? (this.setup = function() {}) : (this.setup = setup);
				(cleanup == null) ? (this.cleanup = function() {}) : (this.cleanup = cleanup);
				this.extend = function(func, code) {
					this[func] = code;
				};
				this.render = function() {
					//TODO: add in render after writing CSS and adding element to body.
				}
			}
			
			
			//All around utils
			var util = {
				lastLayout: new Layout(null, null, null, new ActionBar()),
				lastActionBar: new ActionBar(),
				defaultActionBar: new ActionBar(),
				sysPath: (function() {droid.eventPost("getSysPath", "");var path = droid.eventWaitFor("sysPath").result.data + "/";return path;})(),
				exit: function() {
					droid.eventPost("exit", "");
				},
				showLayout: function(layout) {
					this.lastLayout["cleanup"]();
					layout["render"]();
					layout["setup"]();
					this.lastLayout = layout;
				},
				showActionBar: function(actionBar) {
					this.lastActionBar["cleanup"]();
					actionBar["render"]();
					actionBar["setup"]();
					this.lastActionBar = actionBar;
				},
				addScript: function(url) {
					var ele = document.createElement("script");
					ele.src = ((util.sysPath != undefined) ? (util.sysPath) : ('')) + url;
					ele.type = "text/javascript";
					document.head.appendChild(ele);
				},
				addCSS: function(url) {
					var ele = document.createElement("link");
					ele.href = ((util.sysPath != undefined) ? (util.sysPath) : ('')) + url;
					ele.type = "text/css";
					ele.rel = "stylesheet";
					document.head.appendChild(ele);
				},
				about: function() {
					alert("KoLMobile pre-release v0.1\nMade by KevZho (#2434890)");
				}
			}
			
			//Add CSS first
			util.addCSS("css/roboto.css");
			util.addCSS("css/normalize.css");
			util.addCSS("css/bootstrap.css");
			util.addCSS("css/bootstrap-theme.css");
			util.addCSS("css/signin.css");
			//Load jQuery first, then block until it finishes loading
			util.addScript("scripts/jquery.min.js");
			(function() {
				function blockLoadBootStrap() {
					if ($) {
						util.addScript("scripts/bootstrap.min.js");
					} else {
						setTimeout(blockLoadBootStrap, 50);
					}
				}
			})();
			
			
			//Default action bar
			(function() {
				var actionBar = null;
				var lefts = [];
				var rights = [];
				var options = [];
				var child = document.createElement("li");
				child.innerHTML = '<a href="#"><img src="' + ((util.sysPath != undefined) ? (util.sysPath) : ('')) + 'img/ic_drawer.png" width="48" height="48" alt="Up"></a>';
				lefts.push(child);
				child = document.createElement("li");
				child.innerHTML = '<a href="#"><img src="' + ((util.sysPath != undefined) ? (util.sysPath) : ('')) + 'img/app-logo.png" width="48" height="48" alt="Home"></a>';
				lefts.push(child);
				child = document.createElement("li");
				child.innerHTML = '<a href="#">KoLMobile</a>';
				lefts.push(child);
				child = document.createElement("li");
				child.innerHTML = '<a href="javascript:util.about();"><img src="' + ((util.sysPath != undefined) ? (util.sysPath) : ('')) + 'img/action-about.png" width="32" height="32" alt="About"></a>';
				rights.push(child);
				child = document.createElement("li");
				child.innerHTML = '<a href="#"><img src="' + ((util.sysPath != undefined) ? (util.sysPath) : ('')) + 'img/action-overflow.png" width="32" height="32" id="action-bar-overflow" alt="Menu"></a>';
				rights.push(child);
				child = document.createElement("li");
				child.innerHTML = '<a href="#">Option 1</a>';
				options.push(child);
				child = document.createElement("li");
				child.innerHTML = '<a href="#">Option 2</a>';
				options.push(child);
				child = document.createElement("li");
				child.innerHTML = '<a href="#">Option 3</a>';
				options.push(child);
				actionBar = new ActionBar(lefts, rights, options, function() {
					document.getElementById("action-bar-overflow").onclick = function () {
						$('#action-bar-menu').toggle();
					};
				}, function() {
					document.getElementById("action-bar-overflow").onclick = null;
				});
				util.defaultActionBar = actionBar;
			})();
			
			
			//Login layout
			var login = new Layout('<div class="wrap"><div class="container"><form class="form-signin" role="form" onsubmit="login.handleLogin();return false;"><h2 class="form-signin-heading" id="banner">KoLMobile</h2><input type="text" class="textfield form-control" placeholder="username" required="required" autofocus="autofocus" id="user" autocomplete="off" spellcheck="false" /><input type="password" class="textfield form-control" placeholder="password" required="required" id="pass" /><button class="btn btn-lg btn-primary btn-block" type="submit">Login</button></form><form class="form-signin" role="form" onsubmit="util.exit();return false;"><button id="exit" class="btn btn-lg btn-primary btn-block" type="submit">Exit</button></form></div></div>');
			login.extend("handleLogin", function() {
				droid.objectPost("login", {"user": document.getElementById("user").value, "pass": document.getElementById("pass").value});
				droid.registerCallback("loginResult", function(e) {
					if (e.data == "success") {
						util.showLayout(main);
					} else {
						alert("Login failed.");
					}
				});
			});

			//main menu layout
			var main = new Layout('<div class="wrap"><div class="container"><form class="form-signin" role="form" onsubmit="return false;"><button class="btn btn-lg btn-primary btn-block" onclick="main.requestCharData()">Character Data</button><button class="btn btn-lg btn-primary btn-block" onclick="main.requestInventory()">Inventory</button><button class="btn btn-lg btn-primary btn-block" onclick="main.findInInventory()">Find in inventory</button></form><form class="form-signin" role="form" onsubmit="util.exit();return false;"><button id="exit" class="btn btn-lg btn-primary btn-block" type="submit">Exit</button></form></div></div>');
			main.extend("requestCharData", function() {
					droid.eventPost("charData", "");
			});
			main.extend("requestInventory", function() {
				droid.eventPost("inventory", "");
			});
			main.extend("findInInventory", function() {
				droid.eventPost("findInventory", "");
			});
			main.extend("showChat", function() {
				util.showLayout(chat);
			});
			
			//chat layout
			var chat = new Layout('', function() {this.timedChatGet = setInterval(this.requestNewChats(), 2000);}, function() {clearInterval(this.timedChatGet);});
			chat.extend("timedChatGet", null);
			chat.extend("requestNewChats", function() {
				droid.eventPost("getNewChat", "")
				droid.registerCallback("getNewChatResult", function(e) {
					var rawChats = e.data.split("|chatsplitter|");
					var parsedChats = new Array();
					for (chat in rawChats) {
						parsedChats.push(JSON.parse(chat));
					}
					return parsedChats;
				});
			});
			chat.extend("displayChats", function(chats) {
				// TODO: Add this in after layout is complete
			});
			chat.extend("sendChat", function(chat) {
				droid.eventPost("sendChat", chat)
				droid.registerCallback("sendChatResult", function(e) {
					if (e.data == "success") {
						chat.requestNewChats();
					} else {
						droid.eventPost("makeToast", "Chat send failed");
					}
				});
			});
			chat.extend("mainMenu", function() {
				util.showLayout(main);
			});
			
			window.onload = function() {
				util.showLayout(login);
			};
		</script>
	</head>
	<body>
		<header id="action-bar">
			<ul id="left">
			</ul>
			<ul id="right">
			</ul>
			<nav id="action-bar-menu">
				<ul id="options">
				</ul>
			</nav>
		</header>
		<div id="container" style="width:100%;height:100%;"></div>
	</body>
</html>